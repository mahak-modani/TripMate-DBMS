CREATE TABLE users (
    Join_Date DATE NOT NULL,
    User_ID VARCHAR(10) NOT NULL PRIMARY KEY,
    Name VARCHAR(100) NOT NULL,
    Nationality VARCHAR(50),
    Password VARCHAR(8) NOT NULL,
    Email VARCHAR(100) NOT NULL UNIQUE,
    Phone_Number CHAR(10) NOT NULL UNIQUE,
    Age INT NOT NULL,
    Gender ENUM('M', 'F') NOT NULL,
    interests VARCHAR(255)
);


CREATE TABLE user_history (
    trip_id VARCHAR(10) NOT NULL PRIMARY KEY,
    destination_id VARCHAR(10) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    user_id VARCHAR(10),
    accommodation_type VARCHAR(255),
    accommodation_cost DECIMAL(10, 2),
    transportation_type VARCHAR(255),
    transportation_cost DECIMAL(10, 2),
    budget DECIMAL(10, 2),
    FOREIGN KEY (destination_id) REFERENCES destinations(destination_id),
    FOREIGN KEY (user_id) REFERENCES users(User_ID)
);



CREATE TABLE attractions (
    id INT NOT NULL PRIMARY KEY,
    zone ENUM('Northern', 'Southern', 'Eastern', 'Western', 'Central', 'North Eastern') NOT NULL,
    state VARCHAR(100) NOT NULL,
    city VARCHAR(100) NOT NULL,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(100) NOT NULL,
    year INT,
    time_hr DECIMAL(3,1),
    rating DECIMAL(2,1),
    fee INT,
    airport_50km TINYINT(1),
    weekly_off VARCHAR(50),
    significance TEXT,
    best_daytime VARCHAR(50),
    area VARCHAR(100) NOT NULL
);



CREATE TABLE transport (
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    from_area VARCHAR(100) NOT NULL,
    to_area VARCHAR(100) NOT NULL,
    transport_mode ENUM('Metro', 'Cab', 'Auto') NOT NULL,
    travel_time_minutes INT NOT NULL,
    fare DECIMAL(5, 2) NOT NULL
);


CREATE TABLE itinerary (
    itinerary_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    User_ID VARCHAR(10) NOT NULL,
    trip_id VARCHAR(15) NOT NULL,
    attraction_id INT NOT NULL,
    visit_date DATE NOT NULL,
    visit_time VARCHAR(50),
    travel_time INT,
    transport_mode ENUM('Metro', 'Cab', 'Auto'), 
    FOREIGN KEY (User_ID) REFERENCES users(User_ID),
    FOREIGN KEY (trip_id) REFERENCES user_history(trip_id),
    FOREIGN KEY (attraction_id) REFERENCES attractions(id)
);



CREATE TABLE destinations (
    destination_id VARCHAR(10) PRIMARY KEY,
    city VARCHAR(255) NOT NULL,
    country VARCHAR(255) NOT NULL,
    avg_cost DECIMAL(10,2)
);




DELIMITER $$

CREATE TRIGGER before_insert_users
BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    DECLARE random_num VARCHAR(2);
    
    -- Generate a 2-digit random number
    SET random_num = LPAD(FLOOR(RAND() * 100), 2, '0');
    
    -- Concatenate the YYMM format of Join_Date with the random number to create User_ID
    SET NEW.User_ID = CONCAT(DATE_FORMAT(NEW.Join_Date, '%y%m'), random_num);
END $$

DELIMITER ;




DELIMITER $$

CREATE TRIGGER before_insert_user_history
BEFORE INSERT ON user_history
FOR EACH ROW
BEGIN
    DECLARE random_num VARCHAR(3);
    
    -- Generate a 3-digit random number
    SET random_num = LPAD(FLOOR(RAND() * 1000), 3, '0');
    
    -- Concatenate the YYMM format of start_date with the random number to create trip_id
    SET NEW.trip_id = CONCAT(DATE_FORMAT(NEW.start_date, '%y%m'), random_num);
END $$

DELIMITER ;





DELIMITER $$

CREATE TRIGGER before_insert_destinations
BEFORE INSERT ON destinations
FOR EACH ROW
BEGIN
    DECLARE next_id INT;

    -- Get the current maximum ID (last entry count) and increment it
    SELECT IFNULL(MAX(CAST(SUBSTRING(destination_id, 2) AS UNSIGNED)), 0) + 1
    INTO next_id
    FROM destinations;

    -- Generate the destination_id with the format D029
    SET NEW.destination_id = CONCAT('D', LPAD(next_id, 3, '0'));
END$$

DELIMITER ;

